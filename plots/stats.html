<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>

  <title>Accesibility stats</title>

  <script src='d3.js' type='text/javascript'></script>
  <script src='queue.v1.min.js' type='text/javascript'></script>
  <script src='crossfilter.js' type='text/javascript'></script>
  <script src='../node_modules/dc/dc.js' type='text/javascript'></script>
  <script src='d3-jetpack.js' type='text/javascript'></script>
  <script src='jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='bootstrap.min.js' type='text/javascript'></script>
  <link href='bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='../node_modules/dc/dc.css' rel='stylesheet' type='text/css'>
  

<style>
.header {
    font-weight: bold;
    text-transform: capitalize;
    line-height: 25px;
}
.numberItem {
    margin: 10px;  
    border: solid 1px #eeeeec;
    padding: 5px;
}
#numberList {
    display: flex;
    flex-wrap: wrap;
}
</style>
</head>
<body>
<div class='container' id='main-container'>
<div class='content'>
<div class='container' style='font: 12px sans-serif;'>


  <div class='row dc-data-count'>
    <div class='span12'>
      <div class='row'>
        <h3>% of the population that can reach POIs within # minutes
        </h3>
      </div>
      <div class="row">
      <div id="chart-container"></div>
      </div>
        
    </div>
  </div>

    <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='pie-graph span6' id='dc-county-chart'>
        <h4>Villages by County</h4>
        </div>
      </div>
    </div>
  </div>


</div>
</div>
</div>


<script type="text/javascript">

function accumulate_group(source_group) {
    return {
        all:function () {
            var cumulate = 0;
            var result = [];
            return source_group.all().map(function(d) {
                cumulate += d.value;
                return {key:d.key, value:cumulate};
            });
        }
    };
}
var chart1;
queue()
.defer(d3.csv, '../data/csv/Daozhen%20Gelao%20and%20Miao-1460656194106.csv')
.defer(d3.csv, '../data/csv/Daozhen%20Gelao%20and%20Miao-1460656194106.csv')
.await(buildGraphs)

function buildGraphs(err,normal,fast) {

  normal.forEach(function(d) {
       if (d.POP === "undefined") d.POP = 0;
      d.population  = +d.POP;
      d.banks   = d3.round((+d.banks)/60.,2);
      d.hospitals = d3.round((+d.hospitals)/60.,2);
      d.schools = d3.round((+d.schools)/60.,2);
      d.counties = d3.round((+d.counties)/60.,2);
      d.prefectures = d3.round((+d.prefectures)/60.,2);
      d.county= d.NAME_3;
    });
  fast.forEach(function(d,idx) {
      if (d.POP === "undefined") d.POP = 0;
      d.population  = +d.POP;
      d.banks   = d3.round((+d.banks)/60.,2);
      d.banksOld = normal[idx].banks;
      d.hospitals = d3.round((+d.hospitals)/60.,2);
      d.hospitalsOld = normal[idx].hospitals;
      d.schools = d3.round((+d.schools)/60.,2);
      d.schoolsOld = normal[idx].schools;
      d.counties = d3.round((+d.counties)/60.,2);
      d.countiesOld = normal[idx].counties;
      d.prefectures = d3.round((+d.prefectures)/60.,2);
      d.prefecturesOld = normal[idx].prefectures;
      d.county= d.NAME_3;
    });
  var population = fast.reduce(function(prev,cur){return prev + cur.population},0);
  console.log(population)
  var data = crossfilter(fast);
  var hospitalsValue = data.dimension(ƒ('hospitals'))
  var hospitalsValueGroupSum = hospitalsValue.group()
    .reduceSum(function(d) { return d.population; }); 

  var hospitalsOldValue = data.dimension(ƒ('hospitalsOld'))
  var hospitalsOldValueGroupSum = hospitalsOldValue.group()
    .reduceSum(function(d) { return d.population; }); 

 var schoolsValue = data.dimension(ƒ('schools'))
  var schoolsValueGroupSum = schoolsValue.group()
    .reduceSum(function(d) { return d.population; }); 

  var schoolsOldValue = data.dimension(ƒ('schoolsOld'))
  var schoolsOldValueGroupSum = schoolsOldValue.group()
    .reduceSum(function(d) { return d.population; }); 

 var banksValue = data.dimension(ƒ('banks'))
  var banksValueGroupSum = banksValue.group()
    .reduceSum(function(d) { return d.population; }); 

  var banksOldValue = data.dimension(ƒ('banksOld'))
  var banksOldValueGroupSum = banksOldValue.group()
    .reduceSum(function(d) { return d.population; }); 

 var countiesValue = data.dimension(ƒ('counties'))
  var countiesValueGroupSum = countiesValue.group()
    .reduceSum(function(d) { return d.population; }); 

  var countiesOldValue = data.dimension(ƒ('countiesOld'))
  var countiesOldValueGroupSum = countiesOldValue.group()
    .reduceSum(function(d) { return d.population; }); 

var prefecturesValue = data.dimension(ƒ('prefectures'))
  var prefecturesValueGroupSum = prefecturesValue.group()
    .reduceSum(function(d) { return d.population; }); 

  var prefecturesOldValue = data.dimension(ƒ('prefecturesOld'))
  var prefecturesOldValueGroupSum = prefecturesOldValue.group()
    .reduceSum(function(d) { return d.population; }); 

var isCounty = data.dimension(function (d) {
    return d.county;
    });
  var isCountyGroup = isCounty.group();


  chart1 = dc.compositeChart("#chart-container");
var isCountyChart = dc.rowChart("#dc-county-chart");

 chart1 /* dc.lineChart('#monthly-move-chart', 'chartGroup') */
    .width(900)
    .height(400)
    .x(d3.scale.linear()
    .domain([0, 130]))
    .brushOn(false)
    .clipPadding(1)
    .renderHorizontalGridLines(true)
    .renderVerticalGridLines(true)
    .legend(dc.legend().x(750).y(170).itemHeight(13).gap(5))
    .compose([
            dc.lineChart(chart1)
                .dimension(hospitalsValue)
                .colors('#a6cee3')
                .group(accumulate_group(hospitalsValueGroupSum), "Improved hospitals"),
            dc.lineChart(chart1)
                .dimension(hospitalsOldValue)
                .colors('#1f78b4')
                .group(accumulate_group(hospitalsOldValueGroupSum), "Original hospitals"),

            dc.lineChart(chart1)
                .dimension(banksValue)
                .colors('#b2df8a')
                .group(accumulate_group(banksValueGroupSum), "Improved banks"),
            dc.lineChart(chart1)
                .dimension(banksOldValue)
                .colors('#33a02c')
                .group(accumulate_group(banksOldValueGroupSum), "Original banks"),

            dc.lineChart(chart1)
                .dimension(schoolsValue)
                .colors('#fb9a99')
                .group(accumulate_group(schoolsValueGroupSum), "Improved schools"),
            dc.lineChart(chart1)
                .dimension(schoolsOldValue)
                .colors('#e31a1c')
                .group(accumulate_group(schoolsOldValueGroupSum), "Original schools"),

            dc.lineChart(chart1)
                .dimension(countiesValue)
                .colors('#fdbf6f')
                .group(accumulate_group(countiesValueGroupSum), "Improved counties"),
            dc.lineChart(chart1)
                .dimension(countiesOldValue)
                .colors('#ff7f00')
                .group(accumulate_group(countiesOldValueGroupSum), "Original counties"),

            dc.lineChart(chart1)
                .dimension(prefecturesValue)
                .colors('#cab2d6')
                .group(accumulate_group(prefecturesValueGroupSum), "Improved prefectures"),
            dc.lineChart(chart1)
                .dimension(prefecturesOldValue)
                .colors('#6a3d9a')
                .group(accumulate_group(prefecturesOldValueGroupSum), "Original prefectures")
            ]);

  

  isCountyChart.width(900)
      .height(2020)
      .dimension(isCounty)
      .group(isCountyGroup)
      .title(function(d){return d.value;})
      .render();
chart1.render();
};
    </script>
  </body>
</html>
