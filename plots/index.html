<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>

  <title>Accesibility stats</title>

  <script src='d3.js' type='text/javascript'></script>
  <script src='crossfilter.js' type='text/javascript'></script>
  <script src='dc.js' type='text/javascript'></script>
  <script src='jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='bootstrap.min.js' type='text/javascript'></script>

  <link href='bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='dc.css' rel='stylesheet' type='text/css'>

  <style type="text/css"></style>
</head>

<body>

<div class='container' id='main-container'>
<div class='content'>
<div class='container' style='font: 12px sans-serif;'>

  <div class='row dc-data-count'>
    <div class='span12'>
      <div class='row'>
        <h3><span class="filter-count"></span>
            selected out of
          <span class="total-count"></span></span>
           villages
        </h3>

    </div>
  </div>
  </div>

  <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='pie-graph span6' id='dc-hospital-chart'>
        <h4>Population by time to hospitals</h4>
        </div>
        <div class='pie-graph span6' id='dc-bank-chart'>
	      <h4>Population by time to banks</h4>
        </div>
      </div>
    </div>
  </div>
  <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='pie-graph span6' id='dc-counties-chart'>
        <h4>Population by time to counties</h4>
        </div>
        <div class='pie-graph span6' id='dc-prefectures-chart'>
	      <h4>Population by time to prefectures</h4>
        </div>
      </div>
    </div>
  </div>

  <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='pie-graph span6' id='dc-schools-chart'>
        <h4>Population by time to schools</h4>
        </div>
        <div class='pie-graph span6' id='dc-population-chart'>
	      <h4>Villages by population</h4>
        </div>
      </div>
    </div>
  </div>

  <div class='row'>
    <div class='span12'>
      <div class='row'>
        <div class='pie-graph span6' id='dc-county-chart'>
        <h4>Villages by County</h4>
        </div>
      </div>
    </div>
  </div>

  <div class='row'>
	<div class='pie-graph span12'>
      <table class='table table-hover' id='dc-table-graph'>
        <thead>
          <tr class='header'>
            <th>COUNT</th>
            <th>NAME_2</th>
            <th>NAME_3</th>
            <th>NAME_4</th>
            <th>Population</th>
            <th>Hospitals</th>
            <th>Schools</th>
            <th>Banks</th>
            <th>Counties</th>
            <th>Prefectures</th>
          </tr>
        </thead>
      </table>
	</div>
  </div>



<H5>Generated with
  <a href="http://nickqizhu.github.io/dc.js/">dc.js</a>,
  <a href="http://square.github.io/crossfilter/">crossfilter</a>,
  <a href="http://d3js.org/">d3.js</a> and
  <a href="http://twitter.github.io/bootstrap/">bootstrap</a>.
</H5>

</div>
</div>
</div>

<script>

/**********************************
* Step0: Load data from json file *
**********************************/

// load data from a csv file
/*d3.csv("quakes.csv", function (data) {

  // format our data
  var dtgFormat = d3.time.format("%Y-%m-%dT%H:%M:%S");

  data.forEach(function(d) {
    d.dtg   = dtgFormat.parse(d.origintime.substr(0,19));
    d.lat   = +d.latitude;
    d.long  = +d.longitude;
    d.mag   = d3.round(+d.magnitude,1);
    d.depth = d3.round(+d.depth,0);
  });*/

  d3.csv("normal.csv", function (data) {

    data.forEach(function(d) {
      d.population  = +d.POP;
      d.banks   = d3.round((+d.banks)/60.,0);
      d.hospitals = d3.round((+d.hospitals)/60.,0);
      d.schools = d3.round((+d.schools)/60.,0);
      d.counties = d3.round((+d.counties)/60.,0);
      if (d.prefectures == "Infinity") d.prefectures = -1;
      d.prefectures = d3.round((+d.prefectures)/60.,0);
      d.county= d.NAME_3;
    });

/******************************************************
* Step1: Create the dc.js chart objects & ling to div *
******************************************************/

  var populationChart = dc.barChart("#dc-population-chart");
  var hospitalChart = dc.barChart("#dc-hospital-chart");
  var bankChart = dc.barChart("#dc-bank-chart");
  var schoolsChart = dc.barChart("#dc-schools-chart");
  var prefecturesChart = dc.barChart("#dc-prefectures-chart");
  var countiesChart = dc.barChart("#dc-counties-chart");
  var dataTable = dc.dataTable("#dc-table-graph");
  var isCountyChart = dc.rowChart("#dc-county-chart");

/****************************************
* 	Run the data through crossfilter    *
****************************************/

  var facts = crossfilter(data);  // Gets our 'facts' into crossfilter
  var all = facts.groupAll();

/******************************************************
* Create the Dimensions                               *
* A dimension is something to group or filter by.     *
* Crossfilter can filter by exact value, or by range. *
******************************************************/

// count all the facts
dc.dataCount(".dc-data-count")
  .dimension(facts)
  .group(all);
// for Magnitude -> hospitals
var hospitalsValue = facts.dimension(function (d) {
    return d.hospitals;       // group or filter by hospitals
  });
  var hospitalsValueGroupSum = hospitalsValue.group()
    .reduceSum(function(d) { return d.population; });	// sums the magnitudes per hospitals
  var hospitalsValueGroupCount = hospitalsValue.group()
    .reduceCount(function(d) { return d.hospitals; }) // counts the number of the facts by hospitals
  var maxHospital = hospitalsValue.top(1)[0].hospitals;

  var banksValue = facts.dimension(function (d) {
    return d.banks;       // group or filter by magnitude
  });
  var banksValueGroupSum = banksValue.group()
    .reduceSum(function(d) { return d.population; });	// sums the magnitudes per banks
  var banksValueGroupCount = banksValue.group()
    .reduceCount(function(d) { return d.banks; }) // counts the number of the facts by banks
  var maxBanks = banksValue.top(1)[0].banks;

  var prefecturesValue = facts.dimension(function (d) {
    return d.prefectures;       // group or filter by magnitude
  });
  var prefecturesValueGroupSum = prefecturesValue.group()
    .reduceSum(function(d) { return d.population; });	// sums the magnitudes per counties
  var prefecturesValueGroupCount = prefecturesValue.group()
    .reduceCount(function(d) { return d.prefectures; }) // counts the number of the facts by counties
  var maxPrefectures = prefecturesValue.top(1)[0].prefectures;

  var countiesValue = facts.dimension(function (d) {
    return d.counties;       // group or filter by magnitude
  });
  var countiesValueGroupSum = countiesValue.group()
    .reduceSum(function(d) { return d.population; });	// sums the magnitudes per counties
  var countiesValueGroupCount = countiesValue.group()
    .reduceCount(function(d) { return d.counties; }) // counts the number of the facts by counties
  var maxCounties = countiesValue.top(1)[0].counties;

  var schoolsValue = facts.dimension(function (d) {
    return d.schools;       // group or filter by magnitude
  });
  var schoolsValueGroupSum = schoolsValue.group()
    .reduceSum(function(d) { return d.population; });	// sums the magnitudes per counties
  var schoolsValueGroupCount = schoolsValue.group()
    .reduceCount(function(d) {
      return d.schools; })
      // counts the number of the facts by counties
  var maxSchools = schoolsValue.top(1)[0].schools;

  //For Counties. Pie Chart
  var isCounty = facts.dimension(function (d) {
    return d.county;
    });
  var isCountyGroup = isCounty.group();

  // For datatable
  var populationDimension = facts.dimension(function (d) {
    return d.population;
  }); // group or filter by time
  var populationGroupSum = populationDimension.group()
    .reduceSum(function(d) { return d.population; });

  /*// for Depth
  var depthValue = facts.dimension(function (d) {
    return d.depth;
  });
  var depthValueGroup = depthValue.group();
*/
  // define a daily volume Dimension
  var volumeByPopulation = facts.dimension(function(d) {
    return (d.population);
  });
  // map/reduce to group sum
  var volumeByPopulationCount = volumeByPopulation.group()
    .reduceCount(function(d) { return d.population; });
  var volumeByPopulationGroup = volumeByPopulation.group()
      .reduceSum(function(d) { return d.population; });
  var maxPopulation = volumeByPopulation.top(1)[0].population;

/***************************************
* 	Step4: Create the Visualisations   *
***************************************/

  // hospitalChart Bar Graph Summed
  hospitalChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(hospitalsValue)								// the values across the x axis
    .group(hospitalsValueGroupSum)							// the values on the y axis
	.transitionDuration(500)
    .centerBar(true)
	.gap(56)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear()
    .domain([0, maxHospital]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});

  bankChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(banksValue)								// the values across the x axis
    .group(banksValueGroupSum)							// the values on the y axis
	.transitionDuration(500)
    .centerBar(true)
	.gap(56)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, 200]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});

  schoolsChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(schoolsValue)	// the values across the x axis
    .group(schoolsValueGroupSum) // the values on the y axis
	.transitionDuration(500)
    .centerBar(true)
	.gap(56)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, maxSchools]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});

  prefecturesChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(prefecturesValue)								// the values across the x axis
    .group(prefecturesValueGroupSum)							// the values on the y axis
	.transitionDuration(500)
    .centerBar(true)
	.gap(56)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, maxPrefectures]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});


  countiesChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(countiesValue)								// the values across the x axis
    .group(countiesValueGroupSum)							// the values on the y axis
	.transitionDuration(500)
    .centerBar(true)
	.gap(56)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, maxCounties]))
	.elasticY(true)
  .elasticX(true)
  .xAxis().tickFormat(function(v) {return v;});

  // time graph
  populationChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 60})
    .dimension(volumeByPopulation)
    .group(volumeByPopulationCount)
    .transitionDuration(500)
	.elasticY(true)
    .x(d3.scale.log().domain([1e2, maxPopulation])) // scale and domain of the graph
    .xAxis();

  // Counties Charts
  isCountyChart.width(900)
      .height(2020)
      .margins({top: 5, left: 10, right: 10, bottom: 20})
      .dimension(isCounty)
      .group(isCountyGroup)
      .colors(d3.scale.category20())
      .label(function (d){
         return d.key;
      })
      .title(function(d){return d.value;})
      .xAxis().ticks(4);

  /*isCountyChart.width(250)
    .height(220)
    .radius(100)
    .innerRadius(30)
    .dimension(isCounty)
    .title(function(d){return d.value;})
    .group(isCountyGroup);*/

  // Table of earthquake data
  dataTable.width(960).height(800)
    .dimension(populationDimension)
	.group(function(d) {
    return "List of all villages corresponding to the filters"
	 })
	.size(1000)							// number of rows to return
    .columns([
      function(d) { return d.NAME; },
      function(d) { return d.NAME_2},
      function(d) { return d.NAME_3},
      function(d) { return d.NAME_4; },
      function(d) { return d.POP; },
      function(d) { return d.hospitals; },
      function(d) { return d.schools; },
      function(d) { return d.banks; },
      function(d) { return d.counties; },
      function(d) { return d.prefectures; }
    ])
    .sortBy(function(d){ return d.population; })
    .order(d3.ascending);

/****************************
* Step6: Render the Charts  *
****************************/

  dc.renderAll();

});

</script>

</body>
</html>
