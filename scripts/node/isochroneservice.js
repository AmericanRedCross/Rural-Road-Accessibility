var express = require('express');
var app = express();
var turf = require('turf');
var buffer = require('buffer');
var lineToPolygon = require('turf-line-to-polygon');
var fs = require('fs');
var OSRM = require('osrm');
var Pointsintime = require('./pointsbytime.js');
//var Isochrone = require('osrm-isochrone');
var Isochrone = require('./isochronebypoints.js');
var concaveman = require('concaveman');

/* load the datasets */
var villages = JSON.parse(fs.readFileSync('../../data/Ready to Use/Village_pop.geojson', 'utf8'));

var POIs = {}
POIs.hospitals = JSON.parse(fs.readFileSync('../../data/POIs/hospitals.geojson','utf8'));
POIs.schools = JSON.parse(fs.readFileSync('../../data/POIs/schools.geojson','utf8'));
POIs.banks = JSON.parse(fs.readFileSync('../../data/POIs/banks.geojson','utf8'));
POIs.counties = JSON.parse(fs.readFileSync('../../data/POIs/counties.geojson','utf8'));
POIs.prefectures = JSON.parse(fs.readFileSync('../../data/POIs/prefectures.geojson','utf8'));


var network = '/home/steven/osrm-backend/build/map.osrm';

var allowCrossDomain = function(req, res, next) {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    next();
}
app.use(allowCrossDomain);


app.get('/', function (req, res) {	
  res.send('Hello World!');
});

app.get('/isochrone',function (req, res) {
	var lat = parseFloat(req.query.lat);
	var lon = parseFloat(req.query.lon);
	var scale = parseFloat(req.query.res);
	var time = parseFloat(req.query.time);
	makeIsochrone({lat:lat,lon:lon,scale:scale},res,time);	
})

app.get('/list',function(req,res) {
	var lat = parseFloat(req.query.lat);
	var lon = parseFloat(req.query.lon);
	var time = parseFloat(req.query.time);
	var pois = req.query.pois.split(',');
	createPopList({lat:lat,lon:lon,time:time},res)
})

app.get('/concave',function(req,res) {
	var concavepoints = [[107.17881408,26.83263897],[107.20424483999999,26.82097299],[107.23866084,26.81360397],[107.20945511999999,26.82601596],[107.20451483999999,26.865261],[107.16392592,26.86650498],[107.23366908,26.87408604],[107.21756592,26.87689602],[107.180667,26.88749703],[107.16099516,26.88465996],[107.12842092,26.86184397],[107.20649484,26.86404798],[107.18807111999999,26.86865103],[107.17310016,26.87223501],[107.20648116,26.88618096],[107.22344795999999,26.88372999],[107.19981504,26.86320297],[107.123031,26.86800204],[107.11706904,26.86168701],[107.13684384,26.86979601],[107.15890716,26.88241698],[107.24158295999999,26.88323103],[107.15150483999999,26.87027697],[107.23825116,26.86513698],[107.17145496,26.860419],[107.22662603999999,26.87780097],[107.20184796,26.86171896],[107.16613596,26.86236597],[107.21592396,26.86318398],[107.15936004,26.88756498],[107.18011691999999,26.87142303],[107.23619987999999,26.86102299],[107.23793616,26.87538501],[107.14875516,26.85541599],[107.16064884,26.835516],[107.22893615999999,26.83979001],[107.21489292,26.84934396],[107.19519983999999,26.83949598],[107.18047295999999,26.84692602],[107.21413908,26.85169197],[107.24174604,26.84832399],[107.19336707999999,26.84934099],[107.18492903999999,26.84765898],[107.14477896,26.84683701],[107.17413516,26.84341404],[107.21598911999999,26.84388402],[107.18856503999999,26.84801997],[107.19168516,26.841024],[107.23011804,26.84195199],[107.18420004,26.83436904],[107.20318284,26.83013004],[107.23515803999999,26.83611396],[107.23874507999999,26.81770698],[107.16742115999999,26.83893798],[107.205426,26.88863796],[107.149122,26.88876603],[107.20520892,26.89140204],[107.23790591999999,26.89049502],[107.26805196,26.87263902],[107.26949303999999,26.878095],[107.25703307999999,26.86413402],[107.24816483999999,26.88557598],[107.27079407999999,26.86508001],[107.24748587999999,26.87917599],[107.24208804,26.87872401],[107.25589584,26.87186799],[107.26010496,26.88001101],[107.22078,26.88916302],[107.26264296,26.86329702],[107.24897483999999,26.88131097],[107.25941592,26.88739902],[107.25764904,26.865774],[107.267436,26.86885497],[107.28599184,26.77377897],[107.28939816,26.76888603],[107.28182195999999,26.76093102],[107.27463708,26.76921498],[107.28323784,26.77014198],[107.29060487999999,26.771211],[107.28663012,26.77885596],[107.26769411999999,26.77616397],[107.31905208,26.82350001],[107.253387,26.82768798],[107.25212592,26.81012196],[107.25282288,26.82110304],[107.246277,26.82978696],[107.31148092,26.82047403],[107.25305508,26.82944802],[107.26127496,26.83300401],[107.29981908,26.82461601],[107.28135108,26.83249101],[107.25694307999999,26.79096303],[107.25492707999999,26.79170796],[107.29053792,26.80026903],[107.263602,26.79048099],[107.28428111999999,26.79837696],[107.26763184,26.80206399],[107.28304884,26.78324598],[107.27403084,26.78853897],[107.26998984,26.78670702],[107.27934192,26.789913],[107.29001987999999,26.79407397],[107.27849412,26.79284502],[107.28236988,26.780697],[107.28608904,26.78618097],[107.27517708,26.80273998],[107.24828796,26.79653097],[107.27563896,26.78248998],[107.28929484,26.78155902],[107.29803707999999,26.85128697],[107.266032,26.85218697],[107.25508512,26.85497202],[107.26583616,26.85540204],[107.25261407999999,26.86173597],[107.28752687999999,26.84338596],[107.277858,26.84654001],[107.267373,26.85611403],[107.24560992,26.85450204],[107.26188696,26.85948597],[107.24970491999999,26.83761804],[107.29572407999999,26.84337903],[107.268534,26.85448503],[107.26695503999998,26.85815802],[107.25305291999999,26.837019],[107.27778815999999,26.84094003],[107.29222812,26.80569],[107.24076288,26.830107],[107.24162508,26.79729399],[107.24526,26.79045399],[107.24709204,26.82519201],[107.29079316,26.795745],[107.29936908,26.779095],[107.24245416,26.82697203],[107.25829992,26.77640301],[107.28973188,26.76736296],[107.26354188,26.75581902],[107.22069611999999,26.994393],[107.21030292,26.98280199],[107.22997007999999,26.973792],[107.20190915999999,26.97849801],[107.18724995999999,26.99355798],[107.21187,26.99613198],[107.11473084,26.86791303],[107.12102615999999,26.85933603],[107.13391488,26.85927699],[107.16123816,26.84879901],[107.21147183999999,26.84317104],[107.22247812,26.84227401],[107.20615896,26.85927204],[107.17459091999999,26.94108501],[107.176995,26.94130704],[107.18037,26.93746296],[107.16246792,26.94444201],[107.179929,26.94826098],[107.16422796,26.93670597],[107.17588296,26.94782799],[107.166069,26.94297996],[107.12947284,26.91471096],[107.20460087999999,26.89936803],[107.13939407999999,26.89889904],[107.20775303999999,26.90955396],[107.21085912,26.909658],[107.17823412,26.91432504],[107.18196083999999,26.91443097],[107.136999,26.91160299],[107.14258691999999,26.91172404],[107.14915404,26.91421002],[107.19581111999999,26.91588402],[107.201349,26.90133399],[107.21718684,26.91245196],[107.17901387999999,26.89952796],[107.21657015999999,26.90434899],[107.18216496,26.90055],[107.23278708,26.90883702],[107.21759291999999,26.899524],[107.21628612,26.90228097],[107.19674892,26.90716203],[107.20763604,26.93414196],[107.22617711999999,26.92772496],[107.18221211999999,26.92695699],[107.19052704,26.9262],[107.17710695999999,26.93329902],[107.20048716,26.92052199],[107.17080012,26.925534],[107.16077916,26.91704997],[107.16556608,26.92511901],[107.24112107999998,26.93302902],[107.14218587999999,26.92059201],[107.16361884,26.92426599],[107.14960403999999,26.92166499],[107.14483008,26.922762],[107.19251784,26.93325996],[107.19691307999999,26.92018197],[107.16277104,26.92145196],[107.13824892,26.932608],[107.23269708,26.92489797],[107.20139004,26.93323701],[107.21518488,26.92152],[107.16912611999999,26.93213703],[107.20543715999999,26.92383804],[107.18234711999999,26.9199],[107.15689692,26.92320201],[107.16217991999999,26.92942101],[107.147043,26.91874701],[107.22539015999999,26.87396904],[107.13110004,26.87955498],[107.16737688,26.89274097],[107.23979807999999,26.89263],[107.20223784,26.89374996],[107.17572311999999,26.88070599],[107.16544692,26.89871796],[107.23698216,26.89485201],[107.24311907999999,26.87353704],[107.15100695999999,26.89097796],[107.13528396,26.88569001],[107.213247,26.89125498],[107.233623,26.885484],[107.18135784,26.86737897],[107.21911716,26.884377],[107.13335688,26.89615404],[107.19915803999999,26.88908598],[107.17314516,26.89553502],[107.15874695999999,26.89578396],[107.23367988,26.89731702],[107.24054616,26.90079498],[107.17357284,26.89798401],[107.17309296,26.89316001],[107.21396015999998,26.894259],[107.21043108,26.89481403],[107.21604204,26.89323498],[107.19280296,26.89515801],[107.21673107999999,26.98229601],[107.20413108,26.98455303],[107.22716388,26.982333],[107.22170915999999,26.98876998],[107.24258411999999,26.96410602],[107.23301892,26.96738202],[107.22269087999999,26.97511797],[107.23032504,26.96567904],[107.20616688,26.95054401],[107.23834116,26.95925799],[107.23363092,26.94645702],[107.20519307999999,26.95297104],[107.22013415999999,26.94891798],[107.191827,26.93820501],[107.233083,26.95884399],[107.19404784,26.94656997],[107.20335311999999,26.94916998],[107.23358988,26.95171797],[107.19441396,26.94475197],[107.21571984,26.947665],[107.204679,26.95527198],[107.22062195999999,26.96633199],[107.23332095999999,26.97400296],[107.212257,26.96706198],[107.22752784,26.97853599],[107.24271408,26.95923297],[107.19382103999999,26.94042504],[107.21521584,26.96351904],[107.21952395999999,26.96268402],[107.24402196,26.94270897],[107.23587407999999,26.94735603],[107.20833407999999,26.93887803],[107.17432883999999,26.94939498],[107.24641487999999,26.971164],[107.24918004,26.93535003],[107.20630116,26.94741804],[107.20359108,26.94695499],[107.24509511999999,26.95211703],[107.23035203999999,26.95122],[107.20457784,26.94316698],[107.23313088,26.96617197],[107.23355496,26.97117102],[107.23304592,26.96204898],[107.18695295999999,26.94791196],[107.23130783999999,26.94469698],[107.24093783999999,26.94521601],[107.21268287999999,26.97165198],[107.23507308,26.944092],[107.20336104,26.96983902],[107.18934012,26.98812801],[107.20603512,26.97519096],[107.19817595999999,26.98982496],[107.206821,26.97274197],[107.19667188,26.99864001],[107.20825488,26.98111197],[107.13373092,26.88271704],[107.131518,26.89187499],[107.13206808,26.88750504],[107.11725408,26.87702301],[107.19459,26.99451],[107.16313607999999,26.91593802],[107.162163,26.91374499],[107.13213287999999,26.91271098],[107.15358816,26.91277704],[107.20942091999999,26.90833599],[107.15624603999998,26.92075302],[107.13330287999999,26.918181],[107.20993103999999,26.92143504],[107.19547812,26.91877599],[107.13166415999999,26.90934696],[107.20086588,26.91296802],[107.12888208,26.92106604],[107.17755912,26.91808398],[107.165313,26.91556596],[107.16173208,26.91833499],[107.16883992,26.91713097],[107.187129,26.91965997],[107.16022691999999,26.92711197],[107.14212287999999,26.923914],[107.16476796,26.93096496],[107.188425,26.93065104],[107.16865415999999,26.92707201],[107.17902504,26.92817703],[107.20274688,26.925966],[107.17441596,26.92704897],[107.17304616,26.93463498],[107.20046016,26.92296504],[107.20545515999999,26.93063502],[107.13017484,26.92241397],[107.13350016,26.923275],[107.16985512,26.93046501],[107.175987,26.93029302],[107.14442112,26.926992],[107.14184891999999,26.936181],[107.18318808,26.94621699],[107.17842312,26.89347501],[107.14456908,26.88563601],[107.19794988,26.90454897],[107.18638092,26.89940097],[107.19442692,26.88054201],[107.13963816,26.88344397],[107.18129484,26.88491997],[107.15874588,26.89264701],[107.206614,26.89721199],[107.19987803999999,26.88042303],[107.21008188,26.88138099],[107.18084916,26.876979],[107.15199012,26.88694101],[107.17083396,26.884215],[107.19847908,26.90065296],[107.18218511999999,26.89269399],[107.21068415999999,26.88757299],[107.17717284,26.87657598],[107.18150796,26.88146802],[107.18281692,26.9046],[107.17854587999999,26.90666199],[107.15571612,26.88873696],[107.22368807999999,26.98165998],[107.21275308,26.97512499],[107.22432384,26.97771402],[107.23154688,26.93664099],[107.22375396,26.94115701],[107.16206184,26.93331504],[107.21627783999999,26.91531],[107.21859011999999,26.90610696],[107.23724892,26.94475899],[107.23724388,26.90635797],[107.23346892,26.90505603],[107.21922984,26.93040903],[107.23267584,26.91496404],[107.21641392,26.92832796],[107.22659615999999,26.90717202],[107.21260908,26.92344501],[107.23224491999999,26.92969902],[107.21186784,26.91760698],[107.23556987999999,26.92818198],[107.23548312,26.925363],[107.21453112,26.91726903],[107.21783016,26.90855703],[107.22384288,26.95744503],[107.23468104,26.93446497],[107.21462795999999,26.93698704],[107.21070287999999,26.91407502],[107.22163284,26.93392299],[107.21098584,26.92852101],[107.19915192,26.84034801],[107.15911308,26.84262402],[107.229303,26.837766],[107.19325908,26.82988803],[107.166762,26.83701],[107.16708311999999,26.82947799],[107.18503704,26.83299096],[107.22963384,26.82982701],[107.17614216,26.84188098],[107.22191004,26.82962703],[107.15599008,26.83978596],[107.16163992,26.83886103],[107.18083583999999,26.84047599],[107.185851,26.840115],[107.134011,26.86773996],[107.14402584,26.87793597],[107.149797,26.86640499],[107.21607588,26.88866496],[107.14671216,26.87764698],[107.15756615999999,26.87002902],[107.20977588,26.87523903],[107.21609315999999,26.89850601],[107.21031912,26.90140302],[107.18084916,26.89076997],[107.17121592,26.89160202],[107.150247,26.88328701],[107.19933912,26.86601196],[107.17827983999999,26.86403502],[107.23436496,26.87061996],[107.23746492,26.877204],[107.12014595999999,26.86575402],[107.23640004,26.88024996],[107.20056096,26.87287104],[107.22098592,26.870436],[107.12456712,26.86594302],[107.20764288,26.86965696],[107.16982488,26.86495797],[107.15185007999999,26.875062],[107.15448996,26.86790403],[107.20299311999999,26.87097699],[107.22412404,26.89537401],[107.21195891999999,26.90282304],[107.22049308,26.87995998],[107.19769211999999,26.81384004],[107.23609296,26.81639001],[107.20704887999999,26.81486397],[107.20749708,26.8533],[107.23033908,26.84583504],[107.21573387999999,26.85543903],[107.17886592,26.843634],[107.20296287999999,26.84534904],[107.16214715999999,26.85450402],[107.15630687999999,26.85601404],[107.22560796,26.85938004],[107.18563787999999,26.84601],[107.21692187999999,26.85050397],[107.18646804,26.85682404],[107.15867496,26.860086],[107.16661908,26.84542698],[107.23656996,26.85723696],[107.21814588,26.847405],[107.22925403999999,26.84371401],[107.18409816,26.86153599],[107.20070496,26.85624804],[107.17593516,26.852904],[107.22582216,26.84898504],[107.17276104,26.84942604],[107.20014192,26.98558704],[107.25298596,26.91894402],[107.24464907999999,26.92992303],[107.24988996,26.92166202],[107.23938696,26.92462797],[107.25867215999999,26.91317196],[107.24895504,26.93093904],[107.253387,26.91442404],[107.24569487999999,26.94718197],[107.24344416,26.93702403],[107.25552792,26.90029296],[107.248032,26.88937704],[107.26732691999999,26.88125202],[107.24147208,26.89544403],[107.25249204,26.90981001],[107.26463591999999,26.89443999],[107.23909715999999,26.96653503]]; 
	res.send(concaveman(concavepoints));
})
app.listen(5000, function () {
  console.log('Example app listening on port 5000!');
});

/*
Create isochrones based on the input parameters
*/
var makeIsochrone = function(options,res,time) {
	console.log('make isochrone for:'+options.lon+','+options.lat+' @'+time)
	var destinations = villagesInCircle([options.lon,options.lat],time,60);
	var location = [options.lon,options.lat];
	var o = {
		resolution:options.scale,
		maxspeed: 60,
		unit:'kilometers',
		network:network,
		destinations: destinations
	}
	var result= {"type":"FeatureCollection","features":[]};
	var isochrone = new Isochrone(location,time,o,function(err,drivetime){
		console.log('number of isochrone-features: '+drivetime.features.length);
		//result.features = sumPopulation(drivetime.features);
		res.send(drivetime);
		console.log('send')
	})
	isochrone.getIsochrone()
}

/*
Calculate the population given an array of isochrone-lines
*/
function sumPopulation (features) {
	var result = [];
	if (features.length===0) {
		console.log('NO drivetime features')
	}
    else {
		features.forEach(function (feature) {
			if(feature.geometry.coordinates.length > 3) { 
				var poly = turf.featurecollection([lineToPolygon(feature)]);
				var summedpolygons = turf.sum(poly,villages,'POP','totalPopulation');
				var rfeatures = result.concat(summedpolygons.features);
				result = rfeatures;
			}
		})
	}	
	return result;
}

function createPopList(options,res) {
	console.log('createPopList');
	var destinations = villagesInCircle([options.lon,options.lat],3600,60);
	var location = [options.lon,options.lat];
	var o = {network:network,maxspeed:60,destinations:destinations};
	var pointsintime = new Pointsintime(location,options.time,o,function(err,list){
		console.log(list.features.length + ' villages within given time');
		console.log(list.features.reduce(function(a,b){
			return a+parseInt(b.properties.COUNT)
		},0));
		res.send(list);
	})
    pointsintime.getPointsInTime();
}

function villagesInCircle(center,time,maxspeed) {

	var centerPt = turf.point([center[0],center[1]]);
	var length = (time/3600)*maxspeed;
	var circle = turf.buffer(centerPt,length,'kilometers');
	var result = turf.within(villages,circle);
	console.log(result.features.length +' villages within max distance')
	return result;

}
